import * as React from 'react';
import styles from './ChatbotCopilotIframe.module.scss';
import type { IChatbotCopilotIframeProps } from './IChatbotCopilotIframeProps';

interface IChatbotState {
  isOpen: boolean;
  isAnimating: boolean; // Track animation state for magical effects
}

export default class ChatbotCopilotIframe extends React.Component<IChatbotCopilotIframeProps, IChatbotState> {
  constructor(props: IChatbotCopilotIframeProps) {
    super(props);
    this.state = {
      isOpen: false,
      isAnimating: false
    };
  }

  private toggleChatWindow = (): void => {
    if (this.state.isAnimating) return; // Prevent multiple clicks during animation
    
    this.setState({ isAnimating: true });
    
    if (!this.state.isOpen) {
      // Opening - show chat window with genie emergence animation
      this.setState({ isOpen: true });
      setTimeout(() => {
        this.setState({ isAnimating: false });
      }, 800); // Match enhanced animation duration
    } else {
      // Closing - reverse animation
      setTimeout(() => {
        this.setState({ isOpen: false, isAnimating: false });
      }, 400);
    }
  };

  private closeChatWindow = (): void => {
    if (this.state.isAnimating) return;
    
    this.setState({ isAnimating: true });
    setTimeout(() => {
      this.setState({ isOpen: false, isAnimating: false });
    }, 400);
  };

  private renderGenieLamp = (): React.ReactElement => {
    return (
      <div className={styles.lampContainer}>
        <svg width="60" height="60" viewBox="0 0 226.956 143.837" xmlns="http://www.w3.org/2000/svg" className={styles.lampSvg}>
          {/* Main Genie Lamp SVG - removed white backgrounds */}
          <g>
            <g>
              {/* Removed white background paths */}
              <path fill="#F1F1F1" d="M205.54,25.527l-0.122-0.537l0.171,0.576L205.54,25.527z M220.359,29.156c-0.11-1.658-0.652-3.293-1.601-4.73c-0.119-0.18-0.257-0.366-0.393-0.547c-0.019-0.024-0.038-0.049-0.058-0.074c-0.046-0.059-0.093-0.117-0.138-0.172h-0.001c-0.28-0.34-0.593-0.67-0.91-0.965c-0.318-0.295-0.652-0.565-1.029-0.834c-0.239-0.169-0.549-0.369-0.803-0.517c-0.244-0.142-0.531-0.288-0.784-0.409c-0.036-0.017-0.071-0.033-0.108-0.051c-0.256-0.119-0.51-0.229-0.85-0.355c-0.195-0.072-0.409-0.143-0.63-0.213c-0.023-0.008-0.046-0.014-0.069-0.022c-0.03-0.009-0.06-0.018-0.091-0.027c-0.177-0.052-0.357-0.103-0.529-0.146c-0.203-0.052-0.417-0.102-0.636-0.146c-0.194-0.041-0.393-0.079-0.608-0.115c-0.209-0.035-0.427-0.066-0.674-0.099c-0.184-0.022-0.367-0.043-0.544-0.059c-0.21-0.02-0.421-0.037-0.732-0.053c-0.187-0.011-0.377-0.016-0.528-0.019c-0.24-0.004-0.478-0.008-0.759-0.002c-0.168,0.003-0.339,0.008-0.511,0.018c-0.015,0.001-0.093,0.005-0.107,0.006c-0.247,0.014-0.489,0.027-0.753,0.053c-0.194,0.018-0.388,0.041-0.625,0.072c-0.01,0.002-0.02,0.002-0.031,0.004c-0.024,0.003-0.049,0.006-0.074,0.01c-0.241,0.031-0.48,0.066-0.737,0.111c-0.218,0.039-0.437,0.085-0.657,0.134l0.406,1.888c-0.024,0.008-0.048,0.018-0.072,0.027l-0.428-1.895c-0.256,0.055-0.51,0.114-0.761,0.182c-0.258,0.07-0.515,0.152-0.825,0.252c-0.268,0.087-0.535,0.175-0.79,0.272c-0.311,0.118-0.618,0.256-0.952,0.406c-0.238,0.107-0.479,0.216-0.74,0.351c-0.569,0.295-1.118,0.625-1.632,0.979c-0.043,0.029-0.087,0.059-0.131,0.092c-0.042,0.029-0.084,0.059-0.127,0.089c-1.129-0.03-2.605-0.044-4.341,0.214c-0.104,0.015-0.208,0.032-0.314,0.05c-0.026,0.005-0.054,0.01-0.083,0.015c-0.448,0.079-0.9,0.177-1.352,0.293c-0.184,0.047-0.369,0.096-0.604,0.164c-0.254,0.074-0.504,0.151-0.756,0.238c-0.417,0.143-0.84,0.307-1.251,0.483c-0.178,0.076-0.355,0.156-0.56,0.253c-0.514,0.24-0.992,0.494-1.411,0.736c-0.115,0.067-0.231,0.137-0.331,0.199l-0.213,0.133c-0.504,0.316-0.956,0.625-1.382,0.945c-3.466,2.6-7.287,6.594-11.331,10.821c-3.844,4.018-11.751,12.285-15.04,13.437c-1.164-0.129-2.427-0.977-4.305-2.289c-0.648-0.453-1.339-0.938-2.082-1.407c-0.785-1.257-1.834-2.337-3.095-3.154c-0.429-0.278-0.989-0.593-1.669-0.874c-0.14-0.131-0.284-0.264-0.438-0.403l-0.16-0.144c-0.197-0.176-0.4-0.352-0.622-0.545c-0.044-0.039-0.094-0.082-0.128-0.111c-0.059-0.051-0.119-0.1-0.178-0.149c-4.514-3.7-13.59-9.664-28.699-12.136c0.076-0.607,0.115-1.225,0.115-1.849c0-0.563-0.031-1.127-0.102-1.724c-0.006-0.053-0.013-0.106-0.02-0.157c-0.851-6.744-6.078-11.972-12.789-12.943c-0.175-0.025-0.351-0.047-0.527-0.064c-0.525-0.052-1.029-0.082-1.535-0.082c-8.256,0-14.972,6.717-14.972,14.971c0,0.66,0.044,1.315,0.129,1.957c-12.194,2.22-19.682,7.008-24.128,11.263c-2.454-3.117-5.449-5.612-8.869-7.358c-0.786-0.584-1.673-1.059-2.642-1.391c-4.484-1.535-9.044-1.899-13.579-1.302c-9.862,1.3-18.106,7.118-22.034,16.017c-4.137,9.373-2.78,20.562,3.539,29.202c5.235,7.153,11.531,9.999,16.787,11.519c-0.882,1.812-1.361,3.89-1.379,6.123c-0.045,5.231,3.07,9.826,8.13,11.99c5.755,2.463,12.527,1.207,17.497-3.184c3.697,2.434,8.018,4.492,12.916,6.152c-0.317,0.563-0.626,1.139-0.923,1.73c-0.089,0.178-0.173,0.361-0.245,0.516c-0.04,0.088-0.082,0.175-0.123,0.264c-0.223,0.48-0.448,0.957-0.64,1.406c-0.268,0.627-0.524,1.265-0.764,1.932c-1.257,3.508-1.895,7.057-1.895,10.547c0,2.128,0.714,4.194,2.028,5.867c4.439,5.654,16.165,8.52,34.853,8.52c18.683,0,30.407-2.865,34.848-8.517c1.315-1.673,2.03-3.741,2.03-5.87c0-3.053-0.431-6.107-1.285-9.089c-0.202-0.698-0.433-1.396-0.682-2.081c-0.325-0.895-0.646-1.703-1.002-2.497c-0.39-0.864-0.807-1.692-1.244-2.487c15.902-5.688,28.79-16.898,41.92-35.826c14.417-20.781,24.99-32.133,31.4-33.736c0.738-0.184,1.452-0.445,2.127-0.777c0.156-0.076,0.31-0.154,0.457-0.236c0.092-0.052,0.184-0.105,0.274-0.159c0.477-0.286,0.93-0.616,1.352-0.982c0.816-0.704,1.512-1.54,2.052-2.469c0.072-0.124,0.142-0.249,0.208-0.375c0.428-0.811,0.737-1.679,0.917-2.577c0.023-0.111,0.042-0.223,0.061-0.334c0.072-0.447,0.114-0.899,0.123-1.356C220.384,29.699,220.378,29.427,220.359,29.156L220.359,29.156z M47.286,66.336c-5.609-1.58-8.247-2.897-8.663-5.336c-0.592-3.482,0.825-5.393,2.491-5.742c0.177-0.037,0.358-0.055,0.543-0.055c2.133,0,4.779,2.46,6.548,7.486C47.846,63.865,47.54,65.08,47.286,66.336z"/>
            </g>
            
            {/* Golden Lamp Body */}
            <g>
              <path fill="#FDCB07" d="M49.187,53.967c0.968-2.271,2.125-3.969,3.229-5.221c0,0-2.299-17.729-18.742-17.729c-16.442,0-23.734,17.604-14.428,30.326c9.308,12.719,23.108,5.732,25.907,15.9c1.708,6.203-3.839,6.652-3.839,6.652s0.611-1.717-0.874-2.386c-1.481-0.667-3.924-0.321-3.953,3.168c-0.03,3.493,5.904,5.439,10.151,1.312c4.246-4.133,4.441-11.684-0.322-15.805c-4.759-4.122-23.733-2.927-26.063-16.598C17.09,34.991,42.535,27.303,49.187,53.967z"/>
              <g>
                <path fill="#FDCB07" d="M46.315,70.186c-4.759-4.122-23.733-2.927-26.063-16.598c-3.163-18.597,22.282-26.285,28.934,0.379c0.968-2.271,2.125-3.969,3.229-5.221c0,0-0.108-0.862-0.46-2.207c-0.125,0.229-0.299,0.412-0.52,0.533c-1.688,0.93-5.12-10.471-15.358-11.926c-10.238-1.452-18.089,5.219-18.15,14.643c-0.059,9.42,6.517,14.504,14.504,16.674c5.238,1.426,5.507,3.449,3.041,3.976c4.588,1.03,8.359,2.009,9.679,6.806c1.708,6.203-3.839,6.652-3.839,6.652s0.611-1.717-0.874-2.386c-1.481-0.667-3.924-0.321-3.953,3.168c-0.03,3.493,5.904,5.439,10.151,1.312C50.883,81.857,51.078,74.307,46.315,70.186z"/>
              </g>
            </g>
            
            {/* Crystal/Gem */}
            <g>
              <path fill="#FDCB07" d="M99.607,18.565c0,3.026-2.452,5.476-5.473,5.476c-3.021,0-5.472-2.45-5.472-5.476c0-3.022,2.452-5.469,5.472-5.469C97.155,13.096,99.607,15.543,99.607,18.565z"/>
              <path fill="#FDCB07" d="M95.19,21.93c-2.438,0-4.416-1.979-4.416-4.42c0-2.299,1.761-4.162,4.007-4.374c-0.213-0.024-0.428-0.04-0.648-0.04c-3.021,0-5.472,2.447-5.472,5.469c0,3.026,2.452,5.476,5.472,5.476c3.021,0,5.473-2.45,5.473-5.476c0-0.218-0.017-0.43-0.041-0.643C99.356,20.165,97.487,21.93,95.19,21.93z"/>
            </g>
            
            {/* Main Lamp Body */}
            <g>
              <path fill="#FDCB07" d="M194.307,21.826c-3.257,3.021-6.909-0.579-11.868,3.141c-8.374,6.283-22.802,26.178-31.761,26.178c-7.214,0-11.169-6.168-14.777-6.4c0,0-4.538,2.676-41.767,2.676c-37.228,0-37.501-1.899-37.501-1.899S46.86,49.09,46.86,67.084c0,17.992,22.338,27.922,53.206,27.922c30.717,0,47.317-11.635,64.534-36.454c17.222-24.821,28.008-35.312,36.922-37.542C203.384,20.547,197.566,18.799,194.307,21.826z"/>
              <g style={{opacity: 0.6}}>
                <path fill="#FDCB07" d="M194.968,21.298c-0.029,0.024-0.062,0.048-0.092,0.073c-0.196,0.137-0.388,0.285-0.569,0.455c-0.435,0.402-0.878,0.682-1.331,0.884c-0.926,0.618-2.018,1.307-3.322,2.077c-9.542,5.637-19.431,17.63-35.253,35.547c-15.825,17.918-37.464,28.738-65.741,25.016c-28.276-3.725-33.852-26.992-11.633-31.994c22.224-5.004,59.104,0.988,69.342,1.278c10.241,0.292,14.196-7.096,26.474-19.719c9.036-9.298,12.362-11.259,13.488-11.651c-1.209,0.199-2.495,0.654-3.894,1.703c-8.374,6.283-22.802,26.178-31.761,26.178c-7.214,0-11.169-6.168-14.777-6.4c0,0-4.538,2.676-41.767,2.676c-37.228,0-37.501-1.899-37.501-1.899S46.86,49.09,46.86,67.084c0,17.992,22.338,27.922,53.206,27.922c30.717,0,47.317-11.635,64.534-36.454c17.222-24.821,28.008-35.312,36.922-37.542C203.262,20.575,198.286,19.022,194.968,21.298z"/>
              </g>
              <g>
                <path fill="#FDCB07" d="M198.042,20.172c0.422,0.071,0.845,0.152,1.299,0.199c1.744,0.176,0.084,0.408-2.533,1.832c-2.618,1.424-14.292,4.855-38.451,36.504c-11.697,15.32-31.452,33.195-62.114,31.957c-29.775-1.206-47.485-11.48-44.575-27.419c2.52-13.813,22.338-14.194,42.465-14.194c40.37,0,54.332,8.495,64.029-0.041c8.802-7.748,21.891-23.518,27.315-25.557c-0.958,0.261-1.965,0.709-3.039,1.514c-8.374,6.283-22.802,26.178-31.761,26.178c-7.214,0-11.169-6.168-14.777-6.4c0,0-4.538,2.676-41.767,2.676c-37.228,0-37.501-1.899-37.501-1.899S46.86,49.09,46.86,67.084c0,17.992,22.338,27.922,53.206,27.922c30.717,0,47.317-11.635,64.534-36.454c17.222-24.821,28.008-35.312,36.922-37.542C202.759,20.7,200.592,19.83,198.042,20.172z"/>
              </g>
            </g>
            
            {/* Lamp Opening and Details */}
            <g>
              <path fill="#FDCB07" d="M134.504,42.73c0,0-10.392-13.965-40.33-13.965c-29.941,0-36.066,14.584-36.066,14.584s5.546,1.512,36.026,1.512C124.615,44.861,134.504,42.73,134.504,42.73z"/>
              <g>
                <path fill="#FDCB07" d="M131.709,39.93c-2.963,1.44-7.883,2.75-16.052,3.303c-22.338,1.512-44.327-2.676-38.163-8.68c5.959-5.803,21.254-5.631,22.286-5.611c-1.79-0.111-3.654-0.176-5.606-0.176c-29.941,0-36.066,14.584-36.066,14.584s5.546,1.512,36.026,1.512c30.481,0,40.37-2.131,40.37-2.131S133.641,41.574,131.709,39.93z"/>
              </g>
            </g>
            
            {/* Additional Lamp Components */}
            <g>
              <path fill="#E28426" d="M94.134,47.42c37.229,0,41.767-2.676,41.767-2.676s0.951-2.733-1.397-2.014c0,0-9.889,2.131-40.37,2.131c-30.48,0-36.026-1.512-36.026-1.512c-1.282-0.619-2.892,1.104-1.475,2.171C56.632,45.521,56.905,47.42,94.134,47.42z"/>
              <g style={{opacity: 0.7}}>
                <path fill="#E28426" d="M95.567,46.686c-39.619,0-39.123-2.974-39.123-2.974c-0.458,0.479-0.573,1.237,0.188,1.809c0,0,0.273,1.899,37.501,1.899c37.229,0,41.767-2.676,41.767-2.676s0.249-0.719,0.176-1.325C133.107,44.609,123.872,46.686,95.567,46.686z"/>
              </g>
            </g>
            
            {/* Base/Bottom Pattern */}
            <g>
              <path fill="#FDCB07" d="M71.777,108.605c-0.818,2.285-1.337,4.75-1.337,7.344c0,0,3.836,4.886,27.38,4.886c23.538,0,27.378-4.886,27.378-4.886c0-2.33-0.347-4.483-0.914-6.463c-5.391,1.99-14.074,4.137-26.464,4.137C83.562,113.623,75.705,110.78,71.777,108.605z"/>
              <path fill="#FDCB07" d="M123.071,106.191c-3.509-7.77-10.129-11.971-10.129-11.971c-4.007,0.526-8.284,0.785-12.875,0.785c-6.227,0-12.114-0.404-17.537-1.197c0,0-5.882,4.664-9.438,11.748c4.265,2.045,11.909,4.344,24.729,4.344C109.315,109.9,117.624,108.051,123.071,106.191z"/>
              <path fill="#E28426" d="M97.819,109.9c-12.82,0-20.464-2.299-24.729-4.344c-0.489,0.975-0.933,1.993-1.314,3.049c3.928,2.175,11.785,5.018,26.042,5.018c12.39,0,21.073-2.146,26.464-4.137c-0.335-1.16-0.747-2.256-1.212-3.295C117.624,108.051,109.315,109.9,97.819,109.9z"/>
            </g>
          </g>
        </svg>
        
        {/* Magic sparkles overlay */}
        <div className={styles.sparklesOverlay}>
          <div className={styles.sparkle} style={{top: '10%', left: '15%'}}>
            ✨
          </div>
          <div className={styles.sparkle} style={{top: '20%', right: '10%'}}>
            ⭐
          </div>
          <div className={styles.sparkle} style={{bottom: '15%', left: '20%'}}>
            ✨
          </div>
          <div className={styles.sparkle} style={{top: '60%', right: '15%'}}>
            💫
          </div>
        </div>
        
        {/* Magic smoke effect */}
        <div className={styles.magicSmoke}>
          <div className={styles.smoke} />
          <div className={styles.smoke} />
          <div className={styles.smoke} />
        </div>
      </div>
    );
  };

  private renderSmallGenieLamp = (): React.ReactElement => {
    return (
      <svg width="24" height="24" viewBox="0 0 226.956 143.837" xmlns="http://www.w3.org/2000/svg" className={styles.lampImageSmall}>
        {/* Simplified version of the genie lamp for header */}
        <g>
          {/* Main lamp body in gold */}
          <path fill="#FDCB07" d="M194.307,21.826c-3.257,3.021-6.909-0.579-11.868,3.141c-8.374,6.283-22.802,26.178-31.761,26.178c-7.214,0-11.169-6.168-14.777-6.4c0,0-4.538,2.676-41.767,2.676c-37.228,0-37.501-1.899-37.501-1.899S46.86,49.09,46.86,67.084c0,17.992,22.338,27.922,53.206,27.922c30.717,0,47.317-11.635,64.534-36.454c17.222-24.821,28.008-35.312,36.922-37.542C203.384,20.547,197.566,18.799,194.307,21.826z"/>
          {/* Lamp spout */}
          <path fill="#FDCB07" d="M49.187,53.967c0.968-2.271,2.125-3.969,3.229-5.221c0,0-2.299-17.729-18.742-17.729c-16.442,0-23.734,17.604-14.428,30.326c9.308,12.719,23.108,5.732,25.907,15.9c1.708,6.203-3.839,6.652-3.839,6.652s0.611-1.717-0.874-2.386c-1.481-0.667-3.924-0.321-3.953,3.168c-0.03,3.493,5.904,5.439,10.151,1.312c4.246-4.133,4.441-11.684-0.322-15.805c-4.759-4.122-23.733-2.927-26.063-16.598C17.09,34.991,42.535,27.303,49.187,53.967z"/>
          {/* Lamp opening */}
          <path fill="#FDCB07" d="M134.504,42.73c0,0-10.392-13.965-40.33-13.965c-29.941,0-36.066,14.584-36.066,14.584s5.546,1.512,36.026,1.512C124.615,44.861,134.504,42.73,134.504,42.73z"/>
          {/* Crystal/gem on top */}
          <circle cx="94.134" cy="18.565" r="5.5" fill="#FDCB07"/>
        </g>
      </svg>
    );
  };

  public render(): React.ReactElement<IChatbotCopilotIframeProps> {
    const { isOpen, isAnimating } = this.state;

    return (
      <div className={styles.chatbotContainer}>
        {/* Chat Window - emerges from lamp */}
        {isOpen && (
          <div className={`${styles.chatWindow} ${isAnimating ? styles.emerging : ''}`}>
            <div className={styles.chatHeader}>
              <div className={styles.chatTitle}>
                <div className={styles.avatarSmall}>
                  {this.renderSmallGenieLamp()}
                </div>
                <span>Genie Assistant</span>
              </div>
              <button 
                className={styles.closeButton}
                onClick={this.closeChatWindow}
                title="Close chat"
              >
                ✕
              </button>
            </div>
            <div className={styles.chatBody}>
              <iframe 
                src="https://web.powerva.microsoft.com/environments/Default-64f77dc5-3c66-462b-a765-7e07b045624a/bots/crab7_debby/webchat?__version__=2"
                frameBorder="0"
                className={styles.chatIframe}
                title="Genie Chatbot"
              />
            </div>
          </div>
        )}

        {/* Floating Genie Lamp Button */}
        <button 
          className={`${styles.floatingButton} ${isOpen ? styles.chatOpen : ''} ${isAnimating ? styles.rubbing : ''}`}
          onClick={this.toggleChatWindow}
          title="Rub the lamp to summon your Genie Assistant"
        >
          <div className={styles.avatar}>
            {this.renderGenieLamp()}
          </div>
        </button>
      </div>
    );
  }
}
